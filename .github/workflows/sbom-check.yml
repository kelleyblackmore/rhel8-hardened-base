# checks for old sbom and generates new one if needed and compares them if there is an old one.
# possible to store cyclone dx sbom in github artifacts and compare with new one generated by syft?
name: SBOM Check
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  sbom-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set version variables
        run: |
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          
      - name: Generate SBOM
        run: |
          # Install Syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          # Generate SBOM in CycloneDX format with versioned filename
          syft . -o cyclonedx-json > sbom-${COMMIT_SHA}-${BUILD_DATE}.json
          # Also create a current version for easy comparison
          cp sbom-${COMMIT_SHA}-${BUILD_DATE}.json sbom-current.json
          # Also create a current version for easy comparison
          cp sbom-${COMMIT_SHA}-${BUILD_DATE}.json sbom-current.json
          
      # Download previous SBOM artifact if it exists
      - name: Download previous SBOM artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: sbom-current
          path: ./previous/
          
      - name: Compare SBOMs with Syft and jq
        run: |
          if [ -f "sbom-current.json" ]; then
            echo "New SBOM generated: sbom-${COMMIT_SHA}-${BUILD_DATE}.json"
            if [ -f "previous/sbom-current.json" ]; then
              echo "Comparing with previous SBOM..."
              
              # Extract component information for comparison using jq
              echo "Extracting component lists..."
              jq -r '.components[]? | "\(.name):\(.version)"' sbom-current.json | sort > current-components.txt
              jq -r '.components[]? | "\(.name):\(.version)"' previous/sbom-current.json | sort > previous-components.txt
              
              # Generate detailed diff
              if diff previous-components.txt current-components.txt > sbom-diff-${COMMIT_SHA}-${BUILD_DATE}.txt 2>&1; then
                echo "SBOMs are identical - no dependency changes detected."
                echo "No changes detected" > sbom-diff-${COMMIT_SHA}-${BUILD_DATE}.txt
              else
                echo "SBOM changes detected!"
                echo "Diff saved to: sbom-diff-${COMMIT_SHA}-${BUILD_DATE}.txt"
                echo ""
                echo "--- Component Changes ---"
                
                # Show added components
                NEW_COMPONENTS=$(comm -13 previous-components.txt current-components.txt | wc -l)
                REMOVED_COMPONENTS=$(comm -23 previous-components.txt current-components.txt | wc -l)
                
                echo "Added components: $NEW_COMPONENTS"
                if [ "$NEW_COMPONENTS" -gt 0 ]; then
                  echo "New components:"
                  comm -13 previous-components.txt current-components.txt | head -10
                fi
                
                echo "Removed components: $REMOVED_COMPONENTS" 
                if [ "$REMOVED_COMPONENTS" -gt 0 ]; then
                  echo "Removed components:"
                  comm -23 previous-components.txt current-components.txt | head -10
                fi
                
                echo ""
                echo "Full diff in artifact: sbom-diff-${COMMIT_SHA}-${BUILD_DATE}.txt"
              fi
              
              # Clean up temporary files
              rm -f current-components.txt previous-components.txt
              
            else
              echo "No previous SBOM found for comparison."
              echo "Initial SBOM - no previous version to compare" > sbom-diff-${COMMIT_SHA}-${BUILD_DATE}.txt
            fi
          else
            echo "Failed to generate SBOM."
            exit 1
          fi
          
      - name: Save versioned SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ env.COMMIT_SHA }}-${{ env.BUILD_DATE }}
          path: sbom-${{ env.COMMIT_SHA }}-${{ env.BUILD_DATE }}.json
          retention-days: 365
          
      - name: Save SBOM diff as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-diff-${{ env.COMMIT_SHA }}-${{ env.BUILD_DATE }}
          path: sbom-diff-${{ env.COMMIT_SHA }}-${{ env.BUILD_DATE }}.txt
          retention-days: 365
          
      - name: Save current SBOM for comparison
        uses: actions/upload-artifact@v4
        with:
          name: sbom-current
          path: sbom-current.json
          retention-days: 90