name: Container Security Scan

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:
    branches:
      - '**'  # Run on PRs to any branch
  schedule:
    # Run daily at 2 AM UTC for regular security checks
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  secret-scan:
    name: Secret Scanning with GitLeaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for secret scanning

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}} # Optional: for GitLeaks Pro features

      - name: Upload GitLeaks results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30

  build-and-scan-report:
    name: Build and Scan Container (Report Only)
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.base_ref != 'main'
    permissions:
      contents: read
      packages: write
      security-events: write  # For uploading SARIF results

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true  # Load image locally for scanning
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy for JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          format: 'json'
          output: 'trivy-results.json'

      - name: Run Trivy for table format (human readable)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          format: 'table'
          output: 'trivy-results.txt'

      - name: Display vulnerability summary (non-blocking)
        run: |
          # Count vulnerabilities by severity
          CRITICAL_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          MEDIUM_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)
          LOW_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json)
          
          echo "Vulnerability Summary (Report Only):"
          echo "Critical: $CRITICAL_VULNS"
          echo "High: $HIGH_VULNS"
          echo "Medium: $MEDIUM_VULNS"
          echo "Low: $LOW_VULNS"
          
          echo "Detailed Results:"
          cat trivy-results.txt
          
          echo "Note: This scan is for informational purposes and will not fail the build."

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results-report
          path: |
            trivy-results.sarif
            trivy-results.json
            trivy-results.txt
          retention-days: 30

  build-and-scan-enforce:
    name: Build and Scan Container (Enforce on PR to Main)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    permissions:
      contents: read
      packages: write
      security-events: write  # For uploading SARIF results

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true  # Load image locally for scanning
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy for JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          format: 'json'
          output: 'trivy-results.json'

      - name: Run Trivy for table format (human readable)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan-${{ github.sha }}
          format: 'table'
          output: 'trivy-results.txt'

      - name: Check for HIGH and CRITICAL vulnerabilities (blocking)
        run: |
          # Count HIGH and CRITICAL vulnerabilities
          HIGH_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          CRITICAL_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          
          echo "Vulnerability Summary (Enforcement Mode):"
          echo "Critical: $CRITICAL_VULNS"
          echo "High: $HIGH_VULNS"
          
          # Set outputs for other jobs
          echo "critical_vulns=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
          echo "high_vulns=$HIGH_VULNS" >> $GITHUB_OUTPUT
          
          # Display summary in table format
          echo "Detailed Results:"
          cat trivy-results.txt
          
          # Fail the job if there are CRITICAL vulnerabilities
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "Build failed: $CRITICAL_VULNS CRITICAL vulnerabilities found!"
            echo "Please review and fix critical vulnerabilities before proceeding."
            exit 1
          elif [ "$HIGH_VULNS" -gt 0 ]; then
            echo "Warning: $HIGH_VULNS HIGH severity vulnerabilities found!"
            echo "Consider addressing these vulnerabilities."
          else
            echo "No critical or high severity vulnerabilities found!"
          fi

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results-enforce
          path: |
            trivy-results.sarif
            trivy-results.json
            trivy-results.txt
          retention-days: 30

  filesystem-scan:
    name: Filesystem Scan with Trivy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: Upload filesystem scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

      - name: Run Trivy filesystem scan (table format)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-fs-results.txt'

      - name: Upload filesystem scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-filesystem-results
          path: |
            trivy-fs-results.sarif
            trivy-fs-results.txt
          retention-days: 30
