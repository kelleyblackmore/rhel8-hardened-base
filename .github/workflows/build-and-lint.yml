name: Build and Lint

on:
  push:
    branches:
      - '**'
      - '!main'  # Run on all branches except main
  pull_request:
    branches:
      - main    # Run on PRs targeting main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint-scripts:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "Linting STIG hardening scripts..."
          find scripts/ -name "*.sh" -exec shellcheck {} \;
          
      - name: Lint Containerfile
        run: |
          echo "Installing hadolint..."
          wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x hadolint
          echo "Linting Containerfile..."
          ./hadolint Containerfile

  build-test:
    name: Build and Test Container
    runs-on: ubuntu-latest
    needs: lint-scripts
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container image (test only)
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true  # Load image locally for testing
          tags: |
            test-image:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container functionality
        run: |
          echo "Testing container basic functionality..."
          
          # Test that container starts and has expected user
          docker run --rm test-image:${{ github.sha }} id
          
          # Test that non-root user is active
          docker run --rm test-image:${{ github.sha }} whoami
          
          # Test that required packages are installed
          docker run --rm test-image:${{ github.sha }} rpm -qa | grep -E "(ca-certificates|tzdata|jq)"
          
          # Test STIG script presence (they should be cleaned up after execution)
          docker run --rm test-image:${{ github.sha }} ls -la /tmp/ || true
          
          echo "Container tests passed!"

      - name: Test STIG compliance indicators
        run: |
          echo "Checking for STIG compliance indicators..."
          
          # Check user configuration
          docker run --rm test-image:${{ github.sha }} cat /etc/passwd | grep appuser
          
          # Check file permissions on critical files
          docker run --rm test-image:${{ github.sha }} ls -la /etc/passwd /etc/group
          
          # Check that temporary files are cleaned
          docker run --rm test-image:${{ github.sha }} find /tmp /var/tmp -type f | wc -l
          
          echo "STIG compliance checks completed!"

      - name: Generate build report
        if: always()
        run: |
          echo "## Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          docker image inspect test-image:${{ github.sha }} --format '**Size:** {{.Size}} bytes' >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Linting: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build: Successful" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Tests: Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_This is a test build. Images are not pushed to registry from feature branches._" >> $GITHUB_STEP_SUMMARY